{% extends "layout.html" %}

{% block shell_class %}auth-shell{% endblock %}

{% block head %}
<style>
    .auth-shell {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .auth-shell .page-layout {
        width: 100%;
        max-width: 520px;
        justify-content: center;
    }

    .auth-shell .page-main {
        max-width: 420px;
    }

    .auth-card {
        max-width: 420px;
        padding: 48px 40px 40px;
        text-align: center;
        display: grid;
        gap: 20px;
    }

    .brand {
        font-size: 28px;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        margin-bottom: 4px;
    }

    form {
        display: grid;
        gap: 18px;
        margin-top: 12px;
        text-align: left;
    }

    label {
        font-weight: 600;
        font-size: 14px;
        color: #0f172a;
        display: grid;
        gap: 8px;
    }

    input[type="text"],
    input[type="password"] {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        background: #ffffff;
        color: #0f172a;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
    }

    button[type="submit"] {
        padding: 12px;
        border-radius: 12px;
        border: none;
        background: linear-gradient(135deg, var(--primary), var(--primary-hover));
        color: #ffffff;
        font-weight: 600;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    button[type="submit"]:hover {
        transform: translateY(-1px);
        box-shadow: 0 16px 32px rgba(37, 99, 235, 0.25);
    }

    .helper {
        font-size: 13px;
        color: var(--muted);
        text-align: center;
    }

    .alert {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid #fecaca;
        background: var(--danger-soft);
        color: var(--danger);
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="card auth-card">
    <div class="brand">{{ app_name }}</div>
    <div class="muted">{{ tagline }}</div>
    <form id="login-form">
        <div>
            <label for="username">用户名</label>
            <input id="username" name="username" type="text" autocomplete="username" required placeholder="admin" />
        </div>
        <div>
            <label for="password">密码</label>
            <input id="password" name="password" type="password" autocomplete="current-password" required placeholder="请输入密码" />
        </div>
        <div id="login-alert" class="alert"></div>
        <button type="submit">登录</button>
        <div class="helper muted">
            登录成功后将颁发访问令牌，保存在浏览器中用于后续 API 请求。
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    const TOKEN_KEY = "xxl_admin_token";
    const USERNAME_KEY = "xxl_admin_username";

    if (localStorage.getItem(TOKEN_KEY)) {
        window.location.replace("/admin/dashboard");
    }

    const form = document.getElementById("login-form");
    const alertBox = document.getElementById("login-alert");

    form.addEventListener("submit", async (event) => {
        event.preventDefault();
        alertBox.style.display = "none";
        const formData = new FormData(form);
        const payload = {
            username: formData.get("username")?.trim(),
            password: formData.get("password")?.trim(),
        };

        if (!payload.username || !payload.password) {
            showAlert("请输入用户名和密码");
            return;
        }

        try {
            const response = await fetch("/api/auth/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({ message: "登录失败" }));
                throw new Error(error.message || "登录失败");
            }

            const data = await response.json();
            localStorage.setItem(TOKEN_KEY, data.token);
            localStorage.setItem(USERNAME_KEY, data.username);
            window.location.href = "/admin/dashboard";
        } catch (error) {
            showAlert(error.message || "登录失败，请稍后重试");
        }
    });

    function showAlert(message) {
        alertBox.textContent = message;
        alertBox.style.display = "block";
    }
</script>
{% endblock %}
