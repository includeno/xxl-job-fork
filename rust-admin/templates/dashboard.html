{% extends "layout.html" %}

{% block sidebar %}
<aside class="sidebar card">
    <div class="sidebar-header">
        <div class="sidebar-title">{{ app_name }}</div>
        <div class="sidebar-subtitle muted">分布式任务调度中心</div>
    </div>
    <nav class="sidebar-nav">
        <a class="nav-link{% if active_nav == "dashboard" %} is-active{% endif %}" href="/admin/dashboard">仪表盘</a>
        <a class="nav-link" href="/admin/jobs">任务管理</a>
        <a class="nav-link" href="/admin/groups">执行器管理</a>
        <a class="nav-link" href="/admin/logs">任务日志</a>
    </nav>
</aside>
{% endblock %}

{% block head %}
<style>
    :root {
        --accent: #38bdf8;
        --warning: #facc15;
        --success: #16a34a;
        --danger: #ef4444;
    }

    .dashboard-view {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .top-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px 28px;
        border-radius: 16px;
        background: var(--surface);
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-soft);
    }

    .top-bar h1 {
        margin: 0;
        font-size: 22px;
        letter-spacing: 0.02em;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
        color: #0f172a;
    }

    .user-info button {
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 8px 16px;
        background: var(--surface);
        color: #1f2937;
        transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease;
    }

    .user-info button:hover {
        border-color: var(--primary);
        color: var(--primary);
        background: var(--surface-muted);
    }

    .summary-grid {
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .summary-card {
        padding: 20px 24px;
        border-radius: 16px;
        background: var(--surface);
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-soft);
    }

    .summary-label {
        font-size: 14px;
        font-weight: 500;
        color: var(--muted);
    }

    .summary-value {
        margin-top: 16px;
        font-size: 36px;
        font-weight: 700;
        letter-spacing: 0.04em;
    }

    .chart-card {
        border-radius: 16px;
        border: 1px solid var(--border-color);
        background: var(--surface);
        padding: 24px 28px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        box-shadow: var(--shadow-soft);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
    }

    .chart-header h2 {
        margin: 0;
        font-size: 18px;
    }

    .chart-content {
        display: grid;
        gap: 16px;
        grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
    }

    canvas {
        width: 100%;
        height: 260px;
        border-radius: 12px;
        background: var(--surface-muted);
        border: 1px solid var(--border-color);
    }

    @media (max-width: 1024px) {
        .chart-content {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-view">
    <div class="top-bar card">
        <div>
            <h1>运行概览</h1>
            <div class="muted">掌握集群健康情况与调度趋势</div>
        </div>
        <div class="user-info">
            <span id="welcome-user">--</span>
            <button id="logout" type="button" class="btn btn-secondary">退出登录</button>
        </div>
    </div>

    <section class="card">
        <div class="summary-grid" id="summary-grid">
            <div class="summary-card">
                <span class="summary-label">执行器数量</span>
                <span class="summary-value" data-summary="executorCount">--</span>
            </div>
            <div class="summary-card">
                <span class="summary-label">任务数量</span>
                <span class="summary-value" data-summary="jobCount">--</span>
            </div>
            <div class="summary-card">
                <span class="summary-label">触发次数</span>
                <span class="summary-value" data-summary="triggerCount">--</span>
            </div>
            <div class="summary-card">
                <span class="summary-label">成功调度</span>
                <span class="summary-value" data-summary="successCount">--</span>
            </div>
        </div>
    </section>

    <section class="chart-card">
        <div class="chart-header">
            <h2>最近运行趋势</h2>
            <button id="refresh-chart" type="button" class="btn btn-secondary">刷新</button>
        </div>
        <div class="chart-content">
            <canvas id="chart" width="720" height="320"></canvas>
            <table class="table">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>运行中</th>
                        <th>成功</th>
                        <th>失败</th>
                    </tr>
                </thead>
                <tbody id="chart-table">
                    <tr>
                        <td colspan="4" class="muted">加载中...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>
</div>

<div class="toast" id="toast"></div>
{% endblock %}

{% block scripts %}
<script>
    const TOKEN_KEY = "xxl_admin_token";
    const USERNAME_KEY = "xxl_admin_username";
    const SUMMARY_ENDPOINT = "{{ summary_endpoint }}";
    const CHART_ENDPOINT = "{{ chart_endpoint }}";

    const token = localStorage.getItem(TOKEN_KEY);
    if (!token) {
        window.location.replace("/admin");
    }

    const welcomeUser = document.getElementById("welcome-user");
    const refreshChartBtn = document.getElementById("refresh-chart");
    const chartTable = document.getElementById("chart-table");
    const logoutBtn = document.getElementById("logout");
    const toast = document.getElementById("toast");

    welcomeUser.textContent = localStorage.getItem(USERNAME_KEY) || "未登录";

    logoutBtn.addEventListener("click", () => {
        localStorage.removeItem(TOKEN_KEY);
        localStorage.removeItem(USERNAME_KEY);
        window.location.replace("/admin");
    });

    refreshChartBtn.addEventListener("click", loadData);

    loadData();

    async function loadData() {
        try {
            const [summary, chart] = await Promise.all([
                fetchJson(SUMMARY_ENDPOINT),
                fetchJson(CHART_ENDPOINT),
            ]);
            renderSummary(summary);
            renderChart(chart);
            renderChartTable(chart);
        } catch (error) {
            showToast(error.message || "加载失败", true);
        }
    }

    async function fetchJson(url, options = {}) {
        const response = await fetch(url, {
            ...options,
            headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
                ...(options.headers || {}),
            },
        });
        if (!response.ok) {
            const message = await response.json().catch(() => ({}));
            throw new Error(message.message || response.statusText);
        }
        return response.json();
    }

    function renderSummary(summary) {
        const summaryMap = {
            executorCount: summary.executorCount ?? 0,
            jobCount: summary.jobCount ?? 0,
            triggerCount: summary.triggerCount ?? 0,
            successCount: summary.successCount ?? 0,
        };
        document
            .querySelectorAll('[data-summary]')
            .forEach((el) => (el.textContent = formatNumber(summaryMap[el.dataset.summary] || 0)));
    }

    function renderChart(points) {
        const canvas = document.getElementById('chart');
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        ctx.clearRect(0, 0, width, height);

        const padding = 36;
        const axisY = height - padding;
        const axisX = padding;
        const chartWidth = width - padding * 2;
        const chartHeight = height - padding * 2;

        ctx.strokeStyle = 'rgba(148, 163, 184, 0.35)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(axisX, padding);
        ctx.lineTo(axisX, axisY);
        ctx.lineTo(width - padding, axisY);
        ctx.stroke();

        if (!points.length) {
            ctx.fillStyle = 'rgba(148, 163, 184, 0.5)';
            ctx.fillText('暂无数据', width / 2 - 28, height / 2);
            return;
        }

        const maxValue = Math.max(
            ...points.map((p) => Math.max(p.runningCount ?? 0, p.sucCount ?? 0, p.failCount ?? 0)),
            1,
        );
        const stepX = chartWidth / Math.max(points.length - 1, 1);

        const colors = {
            runningCount: '#facc15',
            sucCount: '#22c55e',
            failCount: '#f87171',
        };

        Object.keys(colors).forEach((metric) => {
            ctx.beginPath();
            ctx.strokeStyle = colors[metric];
            ctx.lineWidth = 2;
            points.forEach((point, index) => {
                const x = axisX + stepX * index;
                const value = point?.[metric] ?? 0;
                const yRatio = value / maxValue;
                const y = axisY - yRatio * chartHeight;
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
        });

        ctx.fillStyle = 'rgba(148, 163, 184, 0.75)';
        ctx.font = '12px "Inter", sans-serif';
        points.forEach((point, index) => {
            const x = axisX + stepX * index;
            ctx.fillText(point.triggerDay, x - 28, height - 8);
        });
    }

    function renderChartTable(points) {
        if (!points.length) {
            chartTable.innerHTML = '<tr><td colspan="4" class="muted">暂无数据</td></tr>';
            return;
        }
        chartTable.innerHTML = points
            .map(
                (point) => `
                    <tr>
                        <td>${point.triggerDay}</td>
                        <td>${point.runningCount ?? 0}</td>
                        <td>${point.sucCount ?? 0}</td>
                        <td>${point.failCount ?? 0}</td>
                    </tr>
                `,
            )
            .join('');
    }

    function formatNumber(value) {
        return new Intl.NumberFormat('zh-CN').format(value);
    }

    function showToast(message, error = false) {
        toast.textContent = message;
        toast.classList.toggle('error', error);
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3200);
    }
</script>
{% endblock %}
